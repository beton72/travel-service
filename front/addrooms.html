<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ù–æ–º–µ—Ä–∞ –æ—Ç–µ–ª—è</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f0f0f0; }
    .room { background: white; padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
    .room h3 { margin: 0 0 8px; }
    .room p { margin: 4px 0; }
    .form { background: white; padding: 20px; border-radius: 8px; margin-top: 30px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
    input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #1358a0; }
    .room img { max-height: 60px; margin-right: 5px; }
  </style>
</head>
<body>
  <button onclick="location.href='index.html'" style="margin-bottom: 20px;">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
  <button onclick="location.href='my-hotels.html'" style="margin-bottom: 20px; margin-left: 10px;">–ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—Ç–µ–ª—è–º–∏</button>

  <h2 id="hotel-title">–ù–æ–º–µ—Ä–∞ –æ—Ç–µ–ª—è</h2>
  <div id="room-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="form">
    <h3 id="form-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä</h3>
    <form id="add-room-form">
      <input type="text" name="type" placeholder="–¢–∏–ø –Ω–æ–º–µ—Ä–∞" required />
      <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required></textarea>
      <input type="number" name="price" placeholder="–¶–µ–Ω–∞" required />
      <input type="number" name="capacity" placeholder="–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å" required />
      <input type="text" name="amenities" placeholder="–£–¥–æ–±—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
      <input type="text" name="photo_urls" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <input type="hidden" name="room_id" />
    </form>
  </div>

  <script>
    const token = localStorage.getItem("token")
    const urlParams = new URLSearchParams(window.location.search)
    const hotelID = urlParams.get("id")

    function loadRooms() {
      if (!hotelID) return console.error("hotelID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")

      fetch(`http://localhost:8080/hotels/${hotelID}`, {
        headers: { "Authorization": "Bearer " + token }
      })
        .then(res => res.json())
        .then(hotel => {
          document.getElementById("hotel-title").textContent = `–ù–æ–º–µ—Ä–∞: ${hotel.Name}`
          const list = document.getElementById("room-list")
          list.innerHTML = ""

          hotel.Rooms.forEach(room => {
            const div = document.createElement("div")
            div.className = "room"
            div.innerHTML = `
              <h3>${room.Type}</h3>
              <p>${room.Description}</p>
              <p>–°—Ç–∞—Ç—É—Å: ${room.status_today === 'booked' ? 'üî¥ –ó–∞–Ω—è—Ç' : 'üü¢ –°–≤–æ–±–æ–¥–µ–Ω'}</p>
              <p>–¶–µ–Ω–∞: ${room.Price}‚ÇΩ | –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${room.Capacity} —á–µ–ª–æ–≤–µ–∫</p>
              <p>–£–¥–æ–±—Å—Ç–≤–∞: ${(room.Amenities || []).join(", ")}</p>
              <div>${(room.PhotoURLs || []).map(url => `<img src='${url}'>`).join("")}</div>
              <button onclick="editRoom(${room.ID}, ${JSON.stringify(room).replace(/"/g, '&quot;')})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button onclick="deleteRoom(${room.ID})">–£–¥–∞–ª–∏—Ç—å</button>
            `
            list.appendChild(div)
          })
        })
        .catch(err => {
          document.getElementById("room-list").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–º–µ—Ä–æ–≤"
          console.error(err)
        })
    }

    function deleteRoom(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä?")) return
      fetch(`http://localhost:8080/rooms/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      })
        .then(res => {
          if (!res.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä")
          loadRooms()
        })
        .catch(err => alert(err.message))
    }

    function editRoom(id, room) {
      const form = document.getElementById("add-room-form")
      document.getElementById("form-title").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä"
      form.room_id.value = room.ID
      form.type.value = room.Type
      form.description.value = room.Description
      form.price.value = room.Price
      form.capacity.value = room.Capacity
      form.amenities.value = (room.Amenities || []).join(", ")
      form.photo_urls.value = (room.PhotoURLs || []).join(", ")
    }

    document.getElementById("add-room-form").addEventListener("submit", function(e) {
      e.preventDefault()
      const form = e.target

      const payload = {
        hotel_id: Number(hotelID),
        type: form.type.value,
        description: form.description.value,
        price: Number(form.price.value),
        capacity: Number(form.capacity.value),
        amenities: form.amenities.value.split(",").map(a => a.trim()).filter(Boolean),
        photo_urls: form.photo_urls.value.split(",").map(p => p.trim()).filter(Boolean)
      }

      const roomId = form.room_id.value
      const method = roomId ? "PATCH" : "POST"
      const url = roomId ? `http://localhost:8080/rooms/${roomId}` : `http://localhost:8080/hotels/${hotelID}/rooms`

      fetch(url, {
        method: method,
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(payload)
      })
        .then(res => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞")
          form.reset()
          document.getElementById("form-title").textContent = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä"
          loadRooms()
        })
        .catch(err => alert(err.message))
    })

    loadRooms()
  </script>
</body>
</html>
