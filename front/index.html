<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–ø–∏—Å–æ–∫ –æ—Ç–µ–ª–µ–π</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f8f8; }
    .hotel { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: 0 0 6px rgba(0,0,0,0.1); display: flex; }
    .hotel-info { flex: 1; }
    .hotel h2 { margin: 0 0 8px; }
    .hotel .region { color: gray; }
    .photos { margin-left: 20px; }
    .photos img { max-height: 120px; margin-bottom: 8px; border-radius: 4px; display:block; }
    button { margin-top: 12px; padding: 6px 12px; border: none; background-color: #1976d2; color: white; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0f5bb5; }
    #account-panel { position: fixed; top: 20px; right: 20px; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
    #account-menu { display: none; margin-top: 10px; }
    #account-menu a { display: block; margin: 4px 0; color: #1976d2; text-decoration: none; }
    #account-menu a:hover { text-decoration: underline; }
    .rating { margin-top: 6px; font-weight: bold; }
    .random-review { margin-top: 6px; font-style: italic; color: #555; }
  </style>
</head>
<body>
  <button onclick="window.location.href='index.html'" style="position: fixed; top: 5px; left: 20px; z-index: 999; padding: 8px 12px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; ">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>

  <div id="account-panel">
    <button onclick="toggleAccountMenu()">üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
    <div id="account-menu">
      <a href="me-profile.html">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</a>
      <a href="my-bookings.html">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</a>
      <a href="my-hotels.html" id="admin-link" style="display:none;">–ú–æ–∏ –æ—Ç–µ–ª–∏ (–∞–¥–º–∏–Ω)</a>
    </div>
  </div>

  <h1>–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ç–µ–ª–∏</h1>

  <form id="region-filter" style="margin-bottom: 20px;">
    <select name="region" required>
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω --</option>
      <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞</option>
      <option value="–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π">–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</option>
      <option value="–ö—Ä—ã–º">–ö—Ä—ã–º</option>
      <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
    </select>
    <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    <button type="button" onclick="loadHotels()">–°–±—Ä–æ—Å–∏—Ç—å</button>
  </form>

  <div id="hotel-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <script>
    function toggleAccountMenu() {
      const menu = document.getElementById("account-menu")
      menu.style.display = menu.style.display === "block" ? "none" : "block"
    }

    function checkRole() {
      const token = localStorage.getItem("token")
      if (!token) return
      try {
        const payload = JSON.parse(atob(token.split(".")[1]))
        if (payload.role === "admin") {
          document.getElementById("admin-link").style.display = "block"
        }
      } catch (e) { console.error("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–∞", e) }
    }

    document.getElementById("region-filter").addEventListener("submit", function(e) {
      e.preventDefault()
      const region = e.target.region.value
      loadHotels(region)
    })

    function loadHotels(region = "") {
      fetch("http://localhost:8080/hotels")
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("hotel-list")
          list.innerHTML = ""

          const filtered = region ? data.filter(h => h.Region === region) : data

          if (filtered.length === 0) {
            list.textContent = "–ù–µ—Ç –æ—Ç–µ–ª–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É —Ä–µ–≥–∏–æ–Ω—É."
            return
          }

          filtered.forEach(hotel => {
            const div = document.createElement("div")
            div.className = "hotel"
            div.innerHTML = `
              <div class="hotel-info">
                <h2>${hotel.Name}</h2>
                <p class="region">${hotel.Region} ‚Ä¢ ${hotel.Address}</p>
                <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${hotel.Phone}</p>
                <p>–ò–ù–ù: ${hotel.INN}</p>
                <p>–£–¥–æ–±—Å—Ç–≤–∞: ${(hotel.Amenities || []).join(', ')}</p>
                <p class="random-review" id="review-${hotel.ID}">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–∞...</p>
                <p class="rating" id="rating-${hotel.ID}">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–∫–∏...</p>
                <button onclick="location.href='rooms.html?id=${hotel.ID}'">–°–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–º–µ—Ä–∞</button>
              </div>
              <div class="photos">
                ${(hotel.PhotoURLs || []).map(url => `<img src="${url}" />`).join('')}
              </div>
            `
            list.appendChild(div)

            // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –æ—Ç–∑—ã–≤–æ–≤
            fetch(`http://localhost:8080/hotels/${hotel.ID}/reviews/stats`)
              .then(res => res.json())
              .then(stats => {
                const el = document.getElementById(`rating-${hotel.ID}`)
                if (stats.average_rating !== undefined) {
                  el.textContent = `–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${stats.average_rating.toFixed(1)} ‚≠ê (${stats.total_reviews} –æ—Ç–∑—ã–≤–æ–≤)`
                } else {
                  el.textContent = "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫"
                }
              })
              .catch(err => {
                document.getElementById(`rating-${hotel.ID}`).textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–π—Ç–∏–Ω–≥–∞"
              })

            fetch(`http://localhost:8080/hotels/${hotel.ID}/reviews/random`)
              .then(res => res.json())
              .then(r => {
                const el = document.getElementById(`review-${hotel.ID}`)
                if (r && r.id) {
                  el.textContent = `\"${r.text}\" ‚Äî ${r.rating}‚≠ê`
                } else {
                  el.textContent = "–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"
                }
              })
              .catch(() => {
                const el = document.getElementById(`review-${hotel.ID}`)
                el.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–∑—ã–≤–∞"
              })
          })
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err)
          document.getElementById("hotel-list").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–µ–ª—è"
        })
    }

    loadHotels()
    checkRole()
  </script>
</body>
</html>